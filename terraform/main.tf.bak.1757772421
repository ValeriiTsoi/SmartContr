terraform {
  required_providers {
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = "~> 2.31"
    }
    helm = {
      source  = "hashicorp/helm"
      version = "~> 2.13"
    }
  }
}

provider "kubernetes" {
  config_path = var.kubeconfig
}

provider "helm" {
  kubernetes {
    config_path = var.kubeconfig
  }
}

# Namespace –¥–ª—è —Ä–µ–ª–∏–∑–∞ (—Å–æ–∑–¥–∞—Å—Ç—Å—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç)
resource "kubernetes_namespace" "dvp" {
  metadata { name = var.namespace }
}

# üîπ ServiceAccount, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Å—Å—ã–ª–∞–µ—Ç—Å—è –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç
#    –ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, —á—Ç–æ –æ–∂–∏–¥–∞–µ—Ç Deployment (dvp-dvp-worker)
resource "kubernetes_service_account" "worker" {
  metadata {
    name      = "dvp-dvp-worker"
    namespace = var.namespace
  }
}

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Helm-—á–∞—Ä—Ç–∞ –≤–æ—Ä–∫–µ—Ä–∞
resource "helm_release" "dvp_worker" {
  name              = "dvp"
  namespace         = kubernetes_namespace.dvp.metadata[0].name
  chart             = "../charts/dvp-worker"
  create_namespace  = false
  timeout           = 300
  wait              = true
  dependency_update = false

  # –Ø–í–ù–û —É–∫–∞–∂–µ–º –∏–º—è SA, –∞ —Å–æ–∑–¥–∞–Ω–∏–µ SA —Å–∞–º–∏–º —á–∞—Ä—Ç–æ–º –æ—Ç–∫–ª—é—á–∏–º (–µ–≥–æ —Å–æ–∑–¥–∞—ë—Ç Terraform)
  set {
    name  = "serviceAccount.create"
    value = "false"
  }
  set {
    name  = "serviceAccount.name"
    value = "dvp-dvp-worker"
  }

  # image
  set {
    name  = "image.repository"
    value = var.image_repository
  }
  set {
    name  = "image.tag"
    value = var.image_tag
  }

  # env (–ø—É–±–ª–∏—á–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
  set {
    name  = "env.RPC_URL"
    value = var.rpc_url
  }
  set {
    name  = "env.CONTRACT_ADDRESS"
    value = var.contract_address
  }
  set {
    name  = "env.REGISTRAR_API_URL"
    value = var.registrar_api_url
  }
  set {
    name  = "env.START_BLOCK"
    value = tostring(var.start_block)
  }

  # secretEnv (—Å–µ–∫—Ä–µ—Ç—ã)
  set_sensitive {
    name  = "secretEnv.ORACLE_PRIVATE_KEY"
    value = var.oracle_private_key
  }
  set_sensitive {
    name  = "secretEnv.REGISTRAR_API_TOKEN"
    value = var.registrar_api_token
  }

  # SA –∏ namespace –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã —Ä–∞–Ω—å—à–µ:
  depends_on = [
    kubernetes_namespace.dvp,
    kubernetes_service_account.worker
  ]
}
